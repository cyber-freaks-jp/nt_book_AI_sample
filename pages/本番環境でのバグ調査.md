# 本番環境でのバグ調査

本番環境で発生したバグは緊急性があるのですぐに解決したいですよね。
**本番環境の情報をAIに渡すことができれば、迅速に解決できます。**

### 本番環境の情報とは

AIに渡すべき「本番環境の情報」には、以下のような情報が含まれます：

- データベースのダンプデータ
- 各種ログ
- インフラのメトリクス（CPU、メモリ、ネットワーク使用率）
- ミドルウェアの設定ファイル（Nginx、MySQL、Redis設定など）
- クラウドリソース情報（AWSのEC2設定、Security Group等）

これらの情報をAIに与えることで、以下のようなバグを調査できます：

| バグの種類          | AIが分析する情報                 |
| -------------- | ------------------------- |
| **アプリケーションバグ** | ログ + DB + コード             |
| **インフラ障害**     | EC2設定 + ミドルウェア設定 + システムログ |
| **パフォーマンス問題**  | メトリクス + スロークエリログ + コード    |

## ただし、セキュリティリスクがある

本番環境のデータには、個人情報や機密情報が含まれています。
**そのため、本番環境で直接AIツールを使うことは絶対にやめましょう**

では、どうすれば安全にAIを活用できるのか？
**答えは、「サンドボックス環境を使う」ことです**

## サンドボックス環境に本番のデータをコピーする

### サンドボックス環境とは

本番のデータベースやAPIにアクセスできない、隔離された環境のことです。

**サンドボックス環境の条件**：
- 本番へ影響を与えないよう通信が遮断されている
- AIが暴走して何をやっても大丈夫な環境
- 機密情報は設置しない（本番データをコピーする際は機密情報をマスキングする）

この条件を満たすなら、ローカルのDocker環境でも、クラウド上の隔離されたVPCでも、どこでもOKです。

### サンドボックス環境の構築方法

運用現場によって構築方法は変わりますが、以下のような方法が考えられます。

#### 方法1：ローカルDocker環境を使う

**イメージ**：
```
本番DB → ダンプ取得 → ローカルDockerのサンドボックスDBに復元
本番ログ → ローカルDockerにコピー
```

**メリット**：
- 簡単に構築できる
- コストがかからない
- 完全に隔離できる

**適している場面**：
- アプリケーションバグの調査
- DBデータの分析

#### 方法2：本番EC2インスタンスのAMIコピーを使う

例えばAWSの場合、本番EC2インスタンスのAMIを作成し、それを別の隔離されたVPCで起動することで、より本番に近いサンドボックス環境を作ることができます。

**イメージ**：
```
本番EC2インスタンス
  ↓ AMI作成
隔離VPC内のEC2インスタンス
  - 本番DBへのアクセス遮断
  - インターネットゲートウェイなし
  - サンドボックスDBのみ接続
```

**メリット**：
- 本番に近い環境で調査できる
- インフラレベルの障害も調査できる
- ミドルウェアの設定もそのまま再現

**適している場面**：
- インフラ障害の調査
- ミドルウェア設定起因のバグ
- パフォーマンス問題の調査

---

**重要**：どの方法を使うかは、組織のセキュリティポリシーや運用ルールによって異なります。**必ず上司やセキュリティ担当者に相談してから実施してください。**


## 重要なセキュリティ原則

本番環境のデータをAIで調査する際は、以下の原則を必ず守ってください。

### 原則1：本番環境で直接AIツールを使わない

- 本番環境でCursor、Claude Code等のAIツールを直接使用しない
- 本番サーバーにAIツールをインストールしない
- 必ず隔離された環境にコピーしてから使う

**理由**：
AIが本番DBを勝手に更新する、本番サーバーで破壊的なコマンドを実行するなど、予期しない動作をするリスクがあります。

### 原則2：ローカル環境でもサンドボックス環境を使う

ローカル環境にAIツールがインストールされていて、かつその環境から本番にSSH接続ができてしまう場合、**AIが本番環境にアクセスできてしまうため、これも絶対にNGです。**

**正しい方法**：
1. ローカル環境上に**サンドボックス環境（Docker）を立てる**
2. サンドボックス環境の中でAIツールを使う
3. サンドボックス環境からは本番に接続できないようにする（SSH設定を分離）

### 原則3：機密情報を除外・マスキングする

**マスキング方法**：

#### 方法1：ダミーデータに置換
```bash
# SQLダンプのメールアドレスを置換
sed -E 's/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/test@example.com/g' dump.sql > masked_dump.sql
```

#### 方法2：機密テーブルを除外
```bash
# 決済情報テーブルを除外してダンプ
mysqldump --ignore-table=database.payments --ignore-table=database.credit_cards database > dump.sql
```

#### 方法3：ログのマスキング
```bash
# ログからトークンをマスキング
sed -E 's/Bearer [A-Za-z0-9_-]+/Bearer ***/g' production.log > masked.log
```

### 原則4：本番への通信を遮断する

サンドボックス環境から本番環境への通信を完全に遮断します。

### 原則5：必ず上司・セキュリティ担当に相談する

- 本番データの取り扱いは個人判断で行わない
- データのコピーや調査方法について、必ず上司の許可を取る
- 組織のセキュリティポリシーに従う
- 不明な点があれば、セキュリティ担当者に相談


## まとめ

本番環境のコンテキスト（ログ、DB、インフラ情報）をAIに安全に渡すことができれば、本番で発生したバグであってもAIで迅速に解決できます。

### 重要なポイント

1. **AIに「本番環境の状態」を再現できる情報を渡すことが鍵**
2. そもそもAIを使って良いか、どういう使い方をするか、必ず上司に相談する
3. **どの方法を使うかは、組織のポリシーによって異なる。組織で統一されたルールを策定することが必須**

